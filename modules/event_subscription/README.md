<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Event Subscription Submodule

This submodule creates an Event Grid event subscription on an Event Grid Topic.

## Purpose

This submodule can be used independently to create event subscriptions on:

- Event Grid Topics created by the parent module
- **Existing Event Grid Topics** not managed by Terraform

This enables scenarios where:

- The topic is managed by a different team
- The topic was created outside of Terraform
- Multiple subscriptions need to be added incrementally

## Usage

### On an existing topic (not managed by Terraform)

```hcl
module "my_subscription" {
  source = "Azure/avm-res-eventgrid-topic/azurerm//modules/event_subscription"

  name                         = "my-subscription"
  event_grid_topic_resource_id = "/subscriptions/.../resourceGroups/.../providers/Microsoft.EventGrid/topics/existing-topic"

  destination = {
    storage_queue = {
      resource_id                           = "/subscriptions/.../resourceGroups/.../providers/Microsoft.Storage/storageAccounts/mystorageaccount"
      queue_name                            = "events"
      queue_message_time_to_live_in_seconds = 300
    }
  }

  filter = {
    subject_begins_with = "/myapp/"
  }
}
```

### With managed identity delivery

```hcl
module "my_subscription" {
  source = "Azure/avm-res-eventgrid-topic/azurerm//modules/event_subscription"

  name                         = "my-subscription"
  event_grid_topic_resource_id = module.eventgrid_topic.resource_id

  delivery_with_resource_identity = {
    identity = {
      type = "SystemAssigned"
    }
    destination = {
      storage_queue = {
        resource_id                           = azurerm_storage_account.example.id
        queue_name                            = "events"
        queue_message_time_to_live_in_seconds = 300
      }
    }
  }

  depends_on = [azurerm_role_assignment.eventgrid_to_storage]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (~> 1.5)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.0)

## Resources

The following resources are used by this module:

- [azapi_resource.this](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)

<!-- markdownlint-disable MD013 -->
## Required Inputs

The following input variables are required:

### <a name="input_event_grid_topic_resource_id"></a> [event\_grid\_topic\_resource\_id](#input\_event\_grid\_topic\_resource\_id)

Description: The resource ID of the Event Grid Topic to create the subscription on.  
This can be an existing topic not managed by the parent module.

Type: `string`

### <a name="input_name"></a> [name](#input\_name)

Description: The name of the event subscription.

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_dead_letter_destination"></a> [dead\_letter\_destination](#input\_dead\_letter\_destination)

Description: Dead letter destination for failed event deliveries. Only StorageBlob is supported.

- `storage_blob` - Storage blob configuration:
  - `resource_id` - Resource ID of the storage account.
  - `blob_container_name` - Name of the blob container for dead letters.

Type:

```hcl
object({
    storage_blob = object({
      resource_id         = string
      blob_container_name = string
    })
  })
```

Default: `null`

### <a name="input_dead_letter_with_resource_identity"></a> [dead\_letter\_with\_resource\_identity](#input\_dead\_letter\_with\_resource\_identity)

Description: Dead letter destination using managed identity.

- `identity` - Identity configuration with `type` and optional `user_assigned_identity`.
- `dead_letter_destination` - Storage blob configuration for dead letters.

Type:

```hcl
object({
    identity = object({
      type                   = string # "SystemAssigned" or "UserAssigned"
      user_assigned_identity = optional(string)
    })
    dead_letter_destination = object({
      storage_blob = object({
        resource_id         = string
        blob_container_name = string
      })
    })
  })
```

Default: `null`

### <a name="input_delivery_with_resource_identity"></a> [delivery\_with\_resource\_identity](#input\_delivery\_with\_resource\_identity)

Description: Delivery configuration using managed identity (recommended for secure RBAC-based delivery).

- `identity` - Identity configuration:
  - `type` - "SystemAssigned" or "UserAssigned"
  - `user_assigned_identity` - Resource ID of user-assigned identity (required if type is "UserAssigned")
- `destination` - Same destination types as `destination` variable.

Note: When using this, ensure the managed identity has appropriate RBAC permissions on the destination resource.

Type:

```hcl
object({
    identity = object({
      type                   = string # "SystemAssigned" or "UserAssigned"
      user_assigned_identity = optional(string)
    })
    destination = object({
      azure_function = optional(object({
        resource_id                       = string
        max_events_per_batch              = optional(number)
        preferred_batch_size_in_kilobytes = optional(number)
        delivery_attribute_mappings = optional(list(object({
          name         = string
          type         = string
          value        = optional(string)
          is_secret    = optional(bool)
          source_field = optional(string)
        })))
      }))
      event_hub = optional(object({
        resource_id = string
        delivery_attribute_mappings = optional(list(object({
          name         = string
          type         = string
          value        = optional(string)
          is_secret    = optional(bool)
          source_field = optional(string)
        })))
      }))
      hybrid_connection = optional(object({
        resource_id = string
        delivery_attribute_mappings = optional(list(object({
          name         = string
          type         = string
          value        = optional(string)
          is_secret    = optional(bool)
          source_field = optional(string)
        })))
      }))
      monitor_alert = optional(object({
        severity      = string
        action_groups = optional(list(string))
        description   = optional(string)
      }))
      namespace_topic = optional(object({
        resource_id = string
      }))
      service_bus_queue = optional(object({
        resource_id = string
        delivery_attribute_mappings = optional(list(object({
          name         = string
          type         = string
          value        = optional(string)
          is_secret    = optional(bool)
          source_field = optional(string)
        })))
      }))
      service_bus_topic = optional(object({
        resource_id = string
        delivery_attribute_mappings = optional(list(object({
          name         = string
          type         = string
          value        = optional(string)
          is_secret    = optional(bool)
          source_field = optional(string)
        })))
      }))
      storage_queue = optional(object({
        resource_id                           = string
        queue_name                            = string
        queue_message_time_to_live_in_seconds = optional(number)
      }))
      webhook = optional(object({
        endpoint_url                         = string
        max_events_per_batch                 = optional(number)
        preferred_batch_size_in_kilobytes    = optional(number)
        azure_active_directory_tenant_id     = optional(string)
        azure_active_directory_app_id_or_uri = optional(string)
        minimum_tls_version_allowed          = optional(string)
        delivery_attribute_mappings = optional(list(object({
          name         = string
          type         = string
          value        = optional(string)
          is_secret    = optional(bool)
          source_field = optional(string)
        })))
      }))
    })
  })
```

Default: `null`

### <a name="input_destination"></a> [destination](#input\_destination)

Description: Direct delivery destination configuration. Specify exactly one destination type.

Supported destination types:
- `azure_function` - Azure Function with `resource_id`, optional `max_events_per_batch`, `preferred_batch_size_in_kilobytes`, and `delivery_attribute_mappings`.
- `event_hub` - Event Hub with `resource_id` and optional `delivery_attribute_mappings`.
- `hybrid_connection` - Hybrid Connection with `resource_id` and optional `delivery_attribute_mappings`.
- `monitor_alert` - Monitor Alert with `severity` (Sev0-Sev4), optional `action_groups` and `description`.
- `namespace_topic` - Event Grid Namespace Topic with `resource_id`.
- `service_bus_queue` - Service Bus Queue with `resource_id` and optional `delivery_attribute_mappings`.
- `service_bus_topic` - Service Bus Topic with `resource_id` and optional `delivery_attribute_mappings`.
- `storage_queue` - Storage Queue with `resource_id`, `queue_name`, and optional `queue_message_time_to_live_in_seconds`.
- `webhook` - WebHook with `endpoint_url` and optional batching/security settings.

Note: Use `destination` for direct delivery or `delivery_with_resource_identity` for managed identity-based delivery, not both.

Type:

```hcl
object({
    # Azure Function destination
    azure_function = optional(object({
      resource_id                       = string
      max_events_per_batch              = optional(number)
      preferred_batch_size_in_kilobytes = optional(number)
      delivery_attribute_mappings = optional(list(object({
        name         = string
        type         = string # "Static" or "Dynamic"
        value        = optional(string)
        is_secret    = optional(bool)
        source_field = optional(string)
      })))
    }))

    # Event Hub destination
    event_hub = optional(object({
      resource_id = string
      delivery_attribute_mappings = optional(list(object({
        name         = string
        type         = string
        value        = optional(string)
        is_secret    = optional(bool)
        source_field = optional(string)
      })))
    }))

    # Hybrid Connection destination
    hybrid_connection = optional(object({
      resource_id = string
      delivery_attribute_mappings = optional(list(object({
        name         = string
        type         = string
        value        = optional(string)
        is_secret    = optional(bool)
        source_field = optional(string)
      })))
    }))

    # Monitor Alert destination
    monitor_alert = optional(object({
      severity      = string # "Sev0", "Sev1", "Sev2", "Sev3", "Sev4"
      action_groups = optional(list(string))
      description   = optional(string)
    }))

    # Namespace Topic destination
    namespace_topic = optional(object({
      resource_id = string
    }))

    # Service Bus Queue destination
    service_bus_queue = optional(object({
      resource_id = string
      delivery_attribute_mappings = optional(list(object({
        name         = string
        type         = string
        value        = optional(string)
        is_secret    = optional(bool)
        source_field = optional(string)
      })))
    }))

    # Service Bus Topic destination
    service_bus_topic = optional(object({
      resource_id = string
      delivery_attribute_mappings = optional(list(object({
        name         = string
        type         = string
        value        = optional(string)
        is_secret    = optional(bool)
        source_field = optional(string)
      })))
    }))

    # Storage Queue destination
    storage_queue = optional(object({
      resource_id                           = string
      queue_name                            = string
      queue_message_time_to_live_in_seconds = optional(number)
    }))

    # WebHook destination
    webhook = optional(object({
      endpoint_url                         = string
      max_events_per_batch                 = optional(number)
      preferred_batch_size_in_kilobytes    = optional(number)
      azure_active_directory_tenant_id     = optional(string)
      azure_active_directory_app_id_or_uri = optional(string)
      minimum_tls_version_allowed          = optional(string) # "1.0", "1.1", "1.2"
      delivery_attribute_mappings = optional(list(object({
        name         = string
        type         = string
        value        = optional(string)
        is_secret    = optional(bool)
        source_field = optional(string)
      })))
    }))
  })
```

Default: `null`

### <a name="input_event_delivery_schema"></a> [event\_delivery\_schema](#input\_event\_delivery\_schema)

Description: The schema for delivered events. Possible values:
- "EventGridSchema" (default)
- "CloudEventSchemaV1\_0"
- "CustomInputSchema"

Type: `string`

Default: `null`

### <a name="input_expiration_time_utc"></a> [expiration\_time\_utc](#input\_expiration\_time\_utc)

Description: The expiration time of the event subscription in UTC (ISO 8601 format).

Type: `string`

Default: `null`

### <a name="input_filter"></a> [filter](#input\_filter)

Description: Event filtering configuration.

- `subject_begins_with` - Filter events with subjects beginning with this prefix.
- `subject_ends_with` - Filter events with subjects ending with this suffix.
- `included_event_types` - List of event types to include.
- `is_subject_case_sensitive` - Whether subject matching is case-sensitive.
- `enable_advanced_filtering_on_arrays` - Enable advanced filtering on arrays.
- `advanced_filters` - List of advanced filters with:
  - `key` - The field to filter on.
  - `operator_type` - The operator (e.g., "StringIn", "NumberGreaterThan").
  - `value` - Single value for comparison operators.
  - `values` - Multiple values for "In" operators.

Type:

```hcl
object({
    subject_begins_with                 = optional(string)
    subject_ends_with                   = optional(string)
    included_event_types                = optional(list(string))
    is_subject_case_sensitive           = optional(bool)
    enable_advanced_filtering_on_arrays = optional(bool)
    advanced_filters = optional(list(object({
      key           = string
      operator_type = string
      value         = optional(any)
      values        = optional(list(any))
    })))
  })
```

Default: `null`

### <a name="input_labels"></a> [labels](#input\_labels)

Description: A list of labels to apply to the event subscription.

Type: `list(string)`

Default: `null`

### <a name="input_retry_policy"></a> [retry\_policy](#input\_retry\_policy)

Description: Retry policy for event delivery.

- `max_delivery_attempts` - Maximum number of delivery attempts (1-30, default 30).
- `event_time_to_live_in_minutes` - Time to live for events in minutes (1-1440, default 1440).

Type:

```hcl
object({
    max_delivery_attempts         = optional(number)
    event_time_to_live_in_minutes = optional(number)
  })
```

Default: `null`

## Outputs

The following outputs are exported:

### <a name="output_name"></a> [name](#output\_name)

Description: The name of the event subscription.

### <a name="output_resource"></a> [resource](#output\_resource)

Description: The full event subscription resource object.

### <a name="output_resource_id"></a> [resource\_id](#output\_resource\_id)

Description: The resource ID of the event subscription.

## Modules

No modules.

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoftâ€™s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->